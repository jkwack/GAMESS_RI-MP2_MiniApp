CPP=icpc
CPP_OFF=icpx

SDIR=./
SRC=${SDIR}/GAMESS-RIMP2-CorrEng-Tutorial.cpp
SRC_V00=${SDIR}/RIMP2_Energy_Whole_Combined_V00.cpp
SRC_V10=${SDIR}/RIMP2_Energy_Whole_Combined_V10.cpp
SRC_V20=${SDIR}/RIMP2_Energy_Whole_Combined_V20.cpp
SRC_V03=${SDIR}/RIMP2_Energy_Whole_Combined_V03.cpp
SRC_V04=${SDIR}/RIMP2_Energy_Whole_Combined_V04.cpp
SRC_V05=${SDIR}/RIMP2_Energy_Whole_Combined_V05.cpp

CPPFLAGS_SERIAL=-Ofast -g
CPPFLAGS_SERIAL+= -xCORE-AVX2

CPPFLAGS_OMP=-Ofast -qopenmp -DOMP -g
CPPFLAGS_OMP+= -xCORE-AVX2

CPPFLAGS_OFFLOAD=-fiopenmp -fopenmp-targets=spir64 -D__STRICT_ANSI__ -DOFFLOAD -g
CPPFLAGS_OFFLOAD+= -mllvm -vpo-paropt-enable-64bit-opencl-atomics=true

CPPFLAGS_MKL_OFFLOAD=-fsycl-device-code-split=per_kernel -fsycl

LDFLAGS_MKL=-mkl=sequential

LDFLAGS_MKL_OFFLOAD=-lmkl_intel_lp64 -lmkl_sequential -lmkl_core
LDFLAGS_MKL_OFFLOAD+= -lmkl_sycl
LDFLAGS_MKL_OFFLOAD+= -lsycl -lOpenCL -lpthread -ldl -lm -lstdc++

EXE_V00=rimp2-CPP-V00-Serial
EXE_V10=rimp2-CPP-V10-OMP
EXE_V20=rimp2-CPP-V20-MKL-OMP
EXE_V03=rimp2-CPP-V03-MKL-OFFLOAD
EXE_V04=rimp2-CPP-V04-MKL-OFFLOAD-OPT01
EXE_V05=rimp2-CPP-V05-MKL-OFFLOAD-OPT02


EXES=$(EXE_V00) $(EXE_V10) $(EXE_V20) $(EXE_V03) $(EXE_V04) $(EXE_V05)

all: $(EXES)

$(EXE_V00): $(SRC) $(SRC_V00)
	$(CPP) $(CPPFLAGS_SERIAL) $^ -o $@ 
	rm -rf *.o *.mod *.modmic

$(EXE_V10): $(SRC) $(SRC_V10)
	$(CPP) $(CPPFLAGS_OMP) $^ -o $@
	rm -rf *.o *.mod *.modmic

$(EXE_V20): $(SRC) $(SRC_V20)
	$(CPP) $(CPPFLAGS_OMP) -DMKL $^ -o $@ $(LDFLAGS_MKL)
	rm -rf *.o *.mod *.modmic

$(EXE_V03): $(SRC) $(SRC_V03)
	$(CPP_OFF) $(CPPFLAGS_OFFLOAD) $(CPPFLAGS_MKL_OFFLOAD) -DV03 -DMKL $^ -o $@ $(LDFLAGS_MKL_OFFLOAD)
	rm -rf *.o *.mod *.modmic

$(EXE_V04): $(SRC) $(SRC_V04)
	$(CPP_OFF) $(CPPFLAGS_OFFLOAD) $(CPPFLAGS_MKL_OFFLOAD) -DV04 -DMKL $^ -o $@ $(LDFLAGS_MKL_OFFLOAD)
	rm -rf *.o *.mod *.modmic

$(EXE_V05): $(SRC) $(SRC_V05)
	$(CPP_OFF) $(CPPFLAGS_OFFLOAD) $(CPPFLAGS_MKL_OFFLOAD) -DV05 -DMKL $^ -o $@ $(LDFLAGS_MKL_OFFLOAD)
	rm -rf *.o *.mod *.modmic


.SUFFIXES:
.SUFFIXES: .c .o .f90 .cu .cpp .cuf
.PHONY: clean
clean:
	rm -rf *.o *.mod *.modmic $(EXES) $(EXES_MKL)
